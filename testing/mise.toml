[settings]
jobs = 1 # Only run one testcase at a time, let's not stack VMs
experimental = true # Required for now for task_templates


[env]
IDM_URI = { required = "copy mise.local.toml.example to mise.local.toml and configure it" }
SSH_PUBLICKEY = { required = "copy mise.local.toml.example to mise.local.toml and configure it" }
# This monstrosity grabs the first version ref mentioned in the workflow definition.
# It assumes the old stable is mentioned first.
OLDSTABLE_VERSION = '''{{ exec(
  cache_key='kanidm_oldstable_version',
  cache_duration='1d',
  command="awk 'match($0, /ref: v*([0-9]+\.[0-9]+)/, a) {printf a[1];exit}' ../.github/workflows/create-apt-repo.yml")}}'''

# This template sets the basis for all test cases, which extend their unique env on top
[task_templates."testcase"]
run = "scripts/run-all.sh"
[task_templates."testcase".env]
SUCCESS_WAIT = "false"

[tasks.test_all]
depends = ["testcase:*"]
description = "Run the entire target list, pausing to allow testing every permutation"

[tasks.test_shell]
description = "Connect to a running test for manual checks"
run = '''
  ssh -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      -o LogLevel=ERROR \
      localhost -p 2222
  '''

[tasks.test_now]
description = "Connect to a running test and run standard checks"
run = '''
  ssh -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      -o LogLevel=ERROR \
      -o PasswordAuthentication=no \
      -o BatchMode=yes \
      localhost -p 2222 \
    "source /etc/test_env && \
    source /etc/os-release && \
    echo \"TEST_ID=\${TEST_ID}\" && \
    getent passwd \$USER && \
    kanidm login -D anonymous && \
    kanidm version && \
    /sbin/kanidm_unixd --version"
  '''

[tasks.debug]
description = "Connect to a running test as root bypassing Kanidm auth"
run = '''
  ssh -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      root@localhost -p 2222 -i ssh_ed25519
'''

# Test cases begin

[tasks."testcase:1e:stable:ext"]
extends = "testcase"
env = { CATEGORY = "stable" }

[tasks."testcase:1s:stable:self"]
extends = "testcase"
env = { CATEGORY = "stable", IDM_URI = "local" }

[tasks."testcase:2e:oldstable-upgrade:ext"]
extends = "testcase"
env = { CATEGORY = "stable", KANIDM_VERSION = "{{env.OLDSTABLE_VERSION}}", KANIDM_UPGRADE = "true" }

[tasks."testcase:2s:oldstable-upgrade:self"]
extends = "testcase"
env = { CATEGORY = "stable", IDM_URI = "local", KANIDM_VERSION = "{{env.OLDSTABLE_VERSION}}", KANIDM_UPGRADE = "true" }

[tasks."testcase:3e:nightly:ext"]
extends = "testcase"
env = { CATEGORY = "nightly" }

[tasks."testcase:3s:nightly:self"]
env = { CATEGORY = "nightly", IDM_URI = "local" }

[tasks."testcase:4e:oldstable:ext"]
extends = "testcase"
env = { CATEGORY = "stable", KANIDM_VERSION = "{{env.OLDSTABLE_VERSION}}" }

[tasks."testcase:4s:oldstable:self"]
extends = "testcase"
env = { CATEGORY = "stable", IDM_URI = "local", KANIDM_VERSION = "{{env.OLDSTABLE_VERSION}}" }

# Test cases end
